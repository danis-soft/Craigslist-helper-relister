var e=require("./common_defs.js"),t=require("./common_storage.js");console.log("Craigslist_helper: + running_content_script"),window.onload=function(){window.jQuery};var o=/accounts.craigslist.org\/login\/home/,n=/post.craigslist.org\/.*?s=edit$/,i=/post.craigslist.org\/.*?s=preview$/,a=/post.craigslist.org\/k\/.*/,s=/post.craigslist.org\/k\/.*s=postcount$/;const l=Object.freeze({ERRORS:{TOO_FAST:"you are posting too rapidly"}});String.prototype.isMatched=function(e){return this.search(e)>-1},console.log(o);var r=document.URL.trim(),c=new Object,g="active",d="expired",u="deleted";async function h(){if(console.log("Detected document is ready.  Attempting to determine the mode according to the document URL"),console.log("Document URL: "+r),r.isMatched(o))mapActivePosts=async function(){let o=null,n=null;if(o=await S(),n=await f(),m(o)&&m(n))console.log("Detected oAllListings && oCurrentListing were defined and not null"),console.log("oCurrentListing.index: "+n.index+" | oAllListings.data.length: "+o.data.length),console.log("oAllListings.data[oCurrentListing.index].repost_url: "+o.data[n.index].repost_url+" == "+n.data.repost_url),n.index<o.data.length&&o.data[n.index].repost_url==n.data.repost_url?(console.log("Detected from storage that we have other outstanding listing to post."),y(o,n)):(console.log("ERROR: Either current listing is out of bounds or current listing data does not match all listing data."),console.log("oCurrentListing.index: "+n.index+" | Repost URLS: "+o.data[n.index].repost_url+" == "+n.data.repost_url),p());else{m(await t.SyncStorage.get(e.KEY_COMPLETED_POSTING))&&(await t.SyncStorage.remove(e.KEY_COMPLETED_POSTING),bootbox.alert("The posting of all the listings has been completed.")),console.log("No other listing detected in storage.  Parsing listings"),async function(){var o=new Map,n=new Map;console.log("Detected dictModes.first mode");var i=null,a=await async function(){return await t.SyncStorage.get(e.KEY_NEVERSHOW_LISTINGS)}();m(a)&&(i=a.data);console.log("Craigslist_helper: adding parameters to dictionary");var s="",l=(new Map,""),r="",h="",p="",_="",f=-1;$("tr.posting-row").each((function(){var e,t;f=-1,s=$(this).children("td.title").text().trim(),l=s.replace(/[\r\n]/gm,"").replace(/[ ]{2,}/g," "),f=l.lastIndexOf("-"),r=f>0&&l.substr(f,l.length).isMatched(/-[ ]*\$[ ]*\d{1,6}$/)?l.substr(0,f):l,console.log("parsed text: "+l),console.log("key text: "+r),console.log(""+$(this).children("td.status").text().trim().toLowerCase().search("active")),(p=$(this).children("td.status").text().trim().toLowerCase()).isMatched(g)?0==o.has(r)&&o.set(r,l):p.isMatched(u)?0==n.has(r)&&n.set(r,l):p.isMatched(d)&&(h=$(this).children("td.buttons.expired").find("form.manage.display").attr("action"),h+="?action=repost",console.log("raw text: "+s),console.log("URL: "+h),console.log("=============================================="),console.log("")),e=/(['"])/g,t="",_=l.replace(e,t),0!=o.has(r)||0!=n.has(r)||_ in c||null!=i&&void 0!==i.find((e=>e.repost_url===h||e.title_no_price===r))||(c[_]={title:l,repost_url:h,title_no_price:r})})),console.log(""),console.log("Printing out mapExpired"),console.log(c),console.log("Printing out mapActive"),console.log(o),console.log(document.URL),console.log("================================"),console.log("================================"),console.log("================================"),console.log("================================")}()}}();else if(r.isMatched(n))R($("input#PostingTitle").val()).then((e=>{e&&$("form#postingForm").submit()}));else if(r.isMatched(i))R($("#titletextonly").html()).then((o=>{o&&_(async function(){var o=await f(),n=2e3,i=2e4,a=1;return a=o.numberOfRepostTries++,w(o.dateCreated)&&(a>1&&(n=Math.floor(Math.random()*(i*(.1*a)))),await t.SyncStorage.save(e.KEY_CURRENT_LISTING,o)),n}()).then($("form#publish_top").submit())}));else if(r.isMatched(s)){console.log("Detected posting too fast link"),(h=$(".body").text().trim().toLowerCase()).length>0&&h.search(l.ERRORS.TOO_FAST)>=0&&(console.log("Detected and confirmed "+l.ERRORS.TOO_FAST+" text"),console.log("Starting to wait"),_(2e4).then((function(){$("form#postingForm").submit()})))}else if(r.isMatched(a)){var h;console.log("Detected fourth mode by URL."),console.log("Trying to make sure by detecting the text"),(h=$("h4:contains('Thanks for posting!')").text().trim().toLowerCase()).length>0&&h.search("we really appreciate it")>=0&&(console.log("Found the text.  Detected the fourth mode for sure."),async function(){let o=null,n=null;o=await S(),n=await f();var i=!0;m(o)&&m(n)&&(n.index++,n.index<o.data.length?(i=!1,n.data=o.data[n.index],console.log("Saving KEY_CURRENT_LISTING entry"),await t.SyncStorage.save(e.KEY_CURRENT_LISTING,n)):(n.index--,await t.SyncStorage.save(e.KEY_COMPLETED_POSTING,n)));i&&(console.log("--------------------------------------"),console.log("ERROR: Fourth mode error. Printing additional data:"),console.log(" Current index: "+n.index+" |  All listings length: "+o.data.length),console.log(n),console.log("--------------------------------------"),p());await _(2e3),L("https://accounts.craigslist.org/login/home")}())}}function p(){console.log("Deleting KEY_ALL_LISTINGS and KEY_CURRENT_LISTING"),Promise.allSettled([t.SyncStorage.remove(e.KEY_ALL_LISTINGS),t.SyncStorage.remove(e.KEY_CURRENT_LISTING)])}function m(e){return!(void 0===e||!e)}function _(e){return function(e){return new Promise((t=>setTimeout(t,e)))}(e)}async function f(){return await t.SyncStorage.get(e.KEY_CURRENT_LISTING)}async function S(){var e;return await(e="craigslist_relister_renew_listings",new Promise(((t,o)=>{chrome.storage.local.get(e,(function(e){t(e.sKey)}))})))}async function R(e){var t,o,n=await f();return m(n)&&console.log("func isContinueRepost | oData.dateCreated: "+n.dateCreated+" | stringSource="+e+", title_no_price = "+n.data.title_no_price),m(n)&&w(n.dateCreated)&&(t=e,o=n.data.title_no_price,m(t)&&m(o)&&t.trim().toLowerCase()==o.trim().toLowerCase())?(console.log("Going along with reposting"),!0):(console.log("WARNING: Reposting failed either due to dateCreated or string match fail."),!1)}function w(e){let t=null,o=null;return t=Date.now(),o=Math.floor((t-e)/1e3)/3600,o<=3}async function y(o=null,n=null){if(console.log("Function invoked: renewListings()"),null==o&&(o=await S()),null==n&&(n=await f()),m(o)&&0==w(o.dateCreated))console.log("ERROR: function renewListings. Either oAllListings is null or dateCreated = false"),p();else{let i=0;if(0==m(n)&&(console.log("Detected current listing does not exist.  Creating new current listing with index 0"),n={dateCreated:Date.now(),dateLastUpdated:Date.now(),numberOfRepostTries:0,index:i,data:o.data[i]}),m(o.data[n.index])&&m(n.data)&&o.data[n.index].repost_url==n.data.repost_url){let o=n.data.repost_url;console.log("element title: "+n.data.title),console.log("trying to go to URL: "+n.data.repost_url),console.log("Saving KEY_CURRENT_LISTING entry"),await t.SyncStorage.save(e.KEY_CURRENT_LISTING,n),L(o)}else console.log("Error URLS do not match.  Cleaning out the Keys for current listing and all the listings"),p()}}function L(e){window.location.href=e}$(document).ready((()=>{h()})),chrome.runtime.onMessage.addListener((function(t,o,n){console.log("Received message"),t.from===e.message_origin.POPUP&&t.to===e.message_destination.CONTENT?(console.log("Received message from popup"),t.type===e.message_type.GET_LISTINGS?(console.log("Received request or data from popup.  Sending in data"),console.log(c),n(c)):t.type===e.message_type.RENEW?y():t.type===e.message_type.REPROCESS_LISTINGS&&function(e){if(t=c,!m(t)&&c.length<1)return;var t;m(e)&&m(e.aNeverShowURLS)&&e.aNeverShowURLS.length>0&&e.aNeverShowURLS.foreach((e=>{console.log("Deleting from gDict by key: "+e),delete c[e]}))}(t.payload)):t.from==e.message_origin.BACKGROUND&&t.type===e.message_type.RENEW&&y(t.payload)}));