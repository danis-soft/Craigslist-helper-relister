/*!
 * @license
 *  - This file is part of Craigslist Helper chrome extension
 *  - Copyright (C) 2020 DaniS Software
 *  - Chrome Extension to update and repost expired Craigslist listing in bulk
 * 
 */!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=2)}([function(e,t,o){"use strict";o.r(t),o.d(t,"STORAGE_KEYS",(function(){return n})),o.d(t,"SAVED_PARAMS",(function(){return r})),o.d(t,"message_origin",(function(){return i})),o.d(t,"message_destination",(function(){return s})),o.d(t,"message_type",(function(){return a})),o.d(t,"isProduction",(function(){return l})),o.d(t,"isNotProduction",(function(){return c})),o.d(t,"outputDebugLog",(function(){return g}));const n=Object.freeze({KEY_ALL_LISTINGS:"craigslist_relister_renew_listings",KEY_NEVERSHOW_LISTINGS:"craigslist_relister_nevershow_listings",KEY_CURRENT_LISTING:"craigslist_relister_current_listing",KEY_COMPLETED_POSTING:"craigslist_relister_completed_posting",KEY_LAST_ERROR_DELAY_USED:"craigslist_relister_last_error_delay_used",KEY_PARAMS:"craigslist_relister_params",LOG_ROLLING:"craigslist_log_rolling"}),r=Object.freeze({SHOW_DELETED_LISTINGS:"bShowDeletedListings",INITIAL_REQUEST:"bInitial"});var i={POPUP:"popup",BACKGROUND:"background",CONTENT:"content_script"},s={CONTENT:"content",BACKGROUND:"background"};const a={RENEW:"renew_listing",GET_LISTINGS:"get_listings",GET_ALL_LISTINGS:"get_all_listings",GET_NEVER_SHOW:"get_nevershow_listings",CLEAR_NEVER_SHOW_LISTINGS:"clear_nevershown_listings",RESET_AND_INTERRUPT_POSTER:"reset_and_interput_poster",REPROCESS_LISTINGS:"reprocess_listings",INITIAL_POPUP_LISTINGS:"initial_popup_listings"};function l(){return!0}function c(){return!1}function g(e){0}},function(e,t,o){"use strict";o.r(t),o.d(t,"SyncStorage",(function(){return n}));var n={save:function(e,t){return new Promise((o,n)=>{t||n("Error: No value specified");var r=new Object;r[e]=t,chrome.storage.local.set(r,(function(){console.log("We have saved all the settings!!! WohOOO"),o("Settings saved")}))})},get:function(e){return new Promise((t,o)=>{chrome.storage.local.get(e,(function(o){t(o[e])}))})},removeAll:function(){chrome.storage.local.clear()},remove:function(e){return new Promise((t,o)=>{chrome.storage.local.remove(e,()=>{t()})})},getAll:function(){return new Promise((e,t)=>{chrome.storage.local.get(null,(function(t){e(t)}))})},getSize:function(){return new Promise((e,t)=>{chrome.storage.local.getBytesInUse(null,t=>{e(t)})})},subscribeToChanges:function(){return new Promise((e,t)=>{chrome.storage.onChanged.addListener((t,o)=>{e(t)})})}}},function(e,t,o){var n=o(0),r=o(1),i=n.outputDebugLog;console.log("Craigslist_helper: + running_content_script"),window.onload=function(){window.jQuery};var s=/accounts.craigslist.org\/login\/home/,a=/post.craigslist.org\/.*?s=edit$/,l=/post.craigslist.org\/.*?s=preview$/,c=/post.craigslist.org\/k\/.*/,g=/post.craigslist.org\/k\/.*s=postcount$/;const u=Object.freeze({ERRORS:{TOO_FAST:"you are posting too rapidly"}});String.prototype.isMatched=function(e){return this.search(e)>-1},console.log(s);var d=document.URL.trim(),S=new Object,_={},E={},p="active",f="expired",R="deleted";async function h(){if(console.log("Detected document is ready.  Attempting to determine the mode according to the document URL"),console.log("Document URL: "+d),d.isMatched(s))mapActivePosts=async function(){let e=null,t=null;if(e=await I(),t=await A(),L(e)&&L(t))console.log("Detected oAllListings && oCurrentListing were defined and not null"),console.log("oCurrentListing.index: "+t.index+" | oAllListings.data.length: "+e.data.length),console.log("oAllListings.data[oCurrentListing.index].repost_url: "+e.data[t.index].repost_url+" == "+t.data.repost_url),t.index<e.data.length&&e.data[t.index].repost_url==t.data.repost_url?(console.log("Detected from storage that we have other outstanding listing to post."),G(e,t)):(console.log("ERROR: Either current listing is out of bounds or current listing data does not match all listing data."),console.log("oCurrentListing.index: "+t.index+" | Repost URLS: "+e.data[t.index].repost_url+" == "+t.data.repost_url),T());else{L(await r.SyncStorage.get(n.STORAGE_KEYS.KEY_COMPLETED_POSTING))&&(await r.SyncStorage.remove(n.STORAGE_KEYS.KEY_COMPLETED_POSTING),bootbox.alert("The posting of all the listings has been completed.  You might need to refresh the page to see the posted listings.")),console.log("No other listing detected in storage.  Parsing listings"),async function(e=!1){new Map,new Map,new Map;console.log("Detected dictModes.first mode");var t=null,o=await async function(){return await r.SyncStorage.get(n.STORAGE_KEYS.KEY_NEVERSHOW_LISTINGS)}();L(o)&&(t=o.data);(function(e,t){var o=new Map,n=new Map,r=new Map;console.log("Craigslist_helper: adding parameters to dictionary");var s="",a="",l="",c="",g="",u=-1;const d={REPOST:"repost",UNDELETE:"undelete"};let S=d.REPOST;$("tr.posting-row").each((function(){u=-1,s=$(this).children("td.title").text().trim(),a=s.replace(/[\r\n]/gm,"").replace(/[ ]{2,}/g," "),u=a.lastIndexOf("-"),l=u>0&&a.substr(u,a.length).isMatched(/-[ ]*\$[ ]*\d{1,6}$/)?a.substr(0,u):a,sTitle=l,l=v(l),console.log("parsed text: "+a),i("key text: "+l),i(""+$(this).children("td.status").text().trim().toLowerCase().search("active")),(g=$(this).children("td.status").text().trim().toLowerCase()).isMatched(p)?0==o.has(l)&&o.set(l,a):g.isMatched(R)?(c=$(this).children("td.buttons").find("form.manage.repost").attr("action"),S=d.REPOST,c+="?action=repost",i("Found deleted"),i("raw text: "+s),i($(this).children("td.postingID.deleted").innerText),i("URL: "+c),c.length>0&&0==n.has(l)&&n.set(l,{title:a,repost_url:c,title_no_price:sTitle,type:S})):g.isMatched(f)&&(c=$(this).children("td.buttons.expired").find("form.manage.display").attr("action"),c+="?action=repost",i("Found expired"),i("raw text: "+s),i("URL: "+c),i("=============================================="),i(""),v(a),(c.length>0&&null==NeverShowURLS||void 0===e.find(e=>e.repost_url===c||e.title_no_price===sTitle))&&r.set(l,{title:a,repost_url:c,title_no_price:sTitle}))})),n.forEach((e,t)=>{o.has(t)||(E[t]=e)}),r.forEach((e,t)=>{o.has(t)||(E[t]=e,_[t]=e)}),console.log(""),console.log("Printing out mapExpired"),console.log(r),console.log("Printing out mapDeletedPosts"),console.log(n),console.log("Printing out mapActive"),console.log(o)})(t),console.log(document.URL),console.log("================================"),console.log("================================"),console.log("================================"),console.log("================================")}()}}();else if(d.isMatched(a))N($("input#PostingTitle").val()).then(e=>{e&&$("form#postingForm").submit()});else if(d.isMatched(l))N($("#titletextonly").html()).then(e=>{e&&y(async function(){var e,t=await A(),o=2e3;return e=t.numberOfRepostTries++,w(t.dateCreated)&&(e>1&&(o=Math.floor(Math.random()*(.1*e*2e4))),await r.SyncStorage.save(n.STORAGE_KEYS.KEY_CURRENT_LISTING,t)),o}()).then($("form#publish_top").submit())});else if(d.isMatched(g)){if(console.log("Detected posting too fast link"),(e=$(".body").text().trim().toLowerCase()).length>0&&e.search(u.ERRORS.TOO_FAST)>=0){console.log("Detected and confirmed "+u.ERRORS.TOO_FAST+" text");let e="Starting to wait.  Current time is: "+(new Date).toLocaleString();console.log(e),O(e),async function(){i("Entering tooFastError function");let e=1;r.SyncStorage.get(n.STORAGE_KEYS.KEY_LAST_ERROR_DELAY_USED).then(t=>(t=m(t)||"number"!=typeof t||Number.isNaN(t)?"110":(t+55)%"360",e=Math.floor(t),r.SyncStorage.save(n.STORAGE_KEYS.KEY_LAST_ERROR_DELAY_USED,e))).then(t=>{let o="Current time: "+(new Date).toLocaleString()+" delay time: "+e+" secs";return console.log(o),O(o),y(e%"360"*1e3)}).then(()=>{let e="Sleep expired => Current time: + "+(new Date).toLocaleString();i(e),O(e),$("form#postingForm").submit()})}()}}else if(d.isMatched(c)){var e;console.log("Detected fourth mode by URL."),console.log("Trying to make sure by detecting the text"),(e=$("h4:contains('Thanks for posting!')").text().trim().toLowerCase()).length>0&&e.search("we really appreciate it")>=0&&(console.log("Found the text.  Detected the fourth mode for sure."),async function(){let e=null,t=null;e=await I(),t=await A();var o=!0;await r.SyncStorage.remove(n.STORAGE_KEYS.KEY_LAST_ERROR_DELAY_USED),L(e)&&L(t)&&(t.index++,t.index<e.data.length?(o=!1,t.data=e.data[t.index],console.log("Saving KEY_CURRENT_LISTING entry"),await r.SyncStorage.save(n.STORAGE_KEYS.KEY_CURRENT_LISTING,t)):(t.index--,await r.SyncStorage.save(n.STORAGE_KEYS.KEY_COMPLETED_POSTING,t)));o&&(console.log("--------------------------------------"),console.log("ERROR: Fourth mode error. Printing additional data:"),console.log(" Current index: "+t.index+" |  All listings length: "+e.data.length),console.log(t),console.log("--------------------------------------"),T());await y(3e3),P("https://accounts.craigslist.org/login/home")}())}}function T(){console.log("Deleting KEY_ALL_LISTINGS and KEY_CURRENT_LISTING"),Promise.allSettled([r.SyncStorage.remove(n.STORAGE_KEYS.KEY_ALL_LISTINGS),r.SyncStorage.remove(n.STORAGE_KEYS.KEY_CURRENT_LISTING)])}function m(e){return!L(e)}function L(e){return!(void 0===e||!e)}function O(e){n.isProduction()||r.SyncStorage.get(n.STORAGE_KEYS.LOG_ROLLING).then(t=>{L(t)&&L(t.log)&&t.log.length>50&&t.log.shift(),m(t)&&(t={log:[]}),t.log.push(e),r.SyncStorage.save(n.STORAGE_KEYS.LOG_ROLLING,t).then(e=>{console.log("Saving to persistent storage under the key of "+n.STORAGE_KEYS.LOG_ROLLING),console.log(e)})}),i(e)}function y(e){return function(e){return new Promise(t=>setTimeout(t,e))}(e)}async function A(){return await r.SyncStorage.get(n.STORAGE_KEYS.KEY_CURRENT_LISTING)}async function I(){return await r.SyncStorage.get(n.STORAGE_KEYS.KEY_ALL_LISTINGS)}async function N(e){var t,o,n=await A();return L(n)&&console.log("func isContinueRepost | oData.dateCreated: "+n.dateCreated+" | stringSource="+e+", title_no_price = "+n.data.title_no_price),L(n)&&w(n.dateCreated)&&(t=e,o=n.data.title_no_price,L(t)&&L(o)&&t.trim().toLowerCase()==o.trim().toLowerCase())?(console.log("Going along with reposting"),!0):(console.log("WARNING: Reposting failed either due to dateCreated or string match fail."),!1)}function w(e){let t=null,o=null;return t=Date.now(),o=Math.floor((t-e)/1e3)/3600,o<=3}async function G(e=null,t=null){if(console.log("Function invoked: renewListings()"),null==e&&(e=await I()),null==t&&(t=await A()),L(e)&&0==w(e.dateCreated))console.log("ERROR: function renewListings. Either oAllListings is null or dateCreated = false"),T();else{let o=0;if(await r.SyncStorage.remove(n.STORAGE_KEYS.KEY_LAST_ERROR_DELAY_USED),0==L(t)&&(console.log("Detected current listing does not exist.  Creating new current listing with index 0"),t={dateCreated:Date.now(),dateLastUpdated:Date.now(),numberOfRepostTries:0,index:o,data:e.data[o]}),L(e.data[t.index])&&L(t.data)&&t.data.repost_url.length>0&&e.data[t.index].repost_url==t.data.repost_url){let e=t.data.repost_url;console.log("element title: "+t.data.title),console.log("trying to go to URL: "+t.data.repost_url),console.log("Saving KEY_CURRENT_LISTING entry"),await r.SyncStorage.save(n.STORAGE_KEYS.KEY_CURRENT_LISTING,t),P(e)}else console.log("Error:  URLS do not match.  Cleaning out the Keys for current listing and all the listings"),T()}}function v(e){return e.replace(/(['"])/g,"")}function P(e){window.location.href=e}$(document).ready(()=>{h()}),chrome.runtime.onMessage.addListener((function(e,t,o){console.log("Received message");var s={params:{},listings:{}};return e.from===n.message_origin.POPUP&&e.to===n.message_destination.CONTENT?(console.log("Received message from popup"),e.type===n.message_type.INITIAL_POPUP_LISTINGS?r.SyncStorage.get(n.STORAGE_KEYS.KEY_PARAMS).then(e=>{m(e)&&((e={})[n.SAVED_PARAMS.SHOW_DELETED_LISTINGS]=!1),e[n.SAVED_PARAMS.SHOW_DELETED_LISTINGS]?(s.params[n.SAVED_PARAMS.SHOW_DELETED_LISTINGS]=!0,s.listings=E):(s.params[n.SAVED_PARAMS.SHOW_DELETED_LISTINGS]=!1,s.listings=_),o(s)}):e.type===n.message_type.GET_LISTINGS&&(console.log("Received request or data from popup.  Sending in data"),console.log(S),r.SyncStorage.save(n.STORAGE_KEYS.KEY_PARAMS,e.value).then(t=>{s.params=e.value,s.listings=_,i(t),o(s)})),e.type===n.message_type.GET_ALL_LISTINGS?r.SyncStorage.save(n.STORAGE_KEYS.KEY_PARAMS,e.value).then(t=>{s.params=e.value,s.listings=E,o(s)}):e.type===n.message_type.RENEW?G():e.type===n.message_type.REPROCESS_LISTINGS&&function(e){if(m(S)&&S.length<1)return;L(e)&&L(e.aNeverShowURLS)&&e.aNeverShowURLS.length>0&&e.aNeverShowURLS.foreach(e=>{console.log("Deleting from gDict by key: "+e),delete S[e]})}(e.payload)):e.from==n.message_origin.BACKGROUND&&e.type===n.message_type.RENEW&&G(e.payload),!0}))}]);